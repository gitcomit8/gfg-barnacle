<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Step Form State Fragmentation Bug Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .bug-alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 20px;
            border-radius: 4px;
        }

        .bug-alert strong {
            color: #856404;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 10px;
        }

        .progress-step:not(:last-child)::after {
            content: '‚Üí';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 20px;
        }

        .progress-step.active {
            color: #667eea;
            font-weight: bold;
        }

        .progress-step.completed {
            color: #28a745;
        }

        .progress-step.buggy {
            color: #dc3545;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .step-content {
            padding: 30px;
            min-height: 400px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .error-box {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 6px;
            padding: 20px;
            margin: 20px;
        }

        .error-box h3 {
            color: #721c24;
            margin-bottom: 10px;
        }

        .success-box {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 6px;
            padding: 20px;
            margin: 20px;
        }

        .success-box h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .data-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .storage-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px;
        }

        .storage-box {
            padding: 20px;
            border-radius: 6px;
            border: 2px solid;
        }

        .global-store {
            background: #d4edda;
            border-color: #28a745;
        }

        .local-state {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .storage-box h4 {
            margin-bottom: 10px;
        }

        .storage-box ul {
            list-style: none;
            padding-left: 0;
        }

        .storage-box li {
            padding: 5px 0;
        }

        .storage-box li::before {
            content: "‚úì ";
            font-weight: bold;
            margin-right: 5px;
        }

        .global-store li::before {
            color: #28a745;
        }

        .local-state li::before {
            content: "‚ö† ";
            color: #dc3545;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêõ Multi-Step Form State Fragmentation</h1>
            <p>A Demonstration of the Checkout Bug</p>
        </div>

        <div class="bug-alert">
            <strong>‚ö†Ô∏è Bug Alert:</strong> This form demonstrates a critical state management bug. 
            Steps 1-3 and 5 use a Global Store, but Step 4 uses local state. 
            Try completing all steps, then clicking "Back" to Step 4 - your data will vanish!
        </div>

        <div class="progress-bar">
            <div class="progress-step" data-step="1">
                <div>Step 1</div>
                <small>Personal Info</small>
            </div>
            <div class="progress-step" data-step="2">
                <div>Step 2</div>
                <small>Shipping</small>
            </div>
            <div class="progress-step" data-step="3">
                <div>Step 3</div>
                <small>Billing</small>
            </div>
            <div class="progress-step buggy" data-step="4">
                <div>Step 4 üêõ</div>
                <small>Special Instructions</small>
            </div>
            <div class="progress-step" data-step="5">
                <div>Step 5</div>
                <small>Review</small>
            </div>
        </div>

        <div class="step-content" id="step-content">
            <!-- Step content will be dynamically inserted here -->
        </div>

        <div class="storage-comparison">
            <div class="storage-box global-store">
                <h4>‚úÖ Global Store</h4>
                <ul>
                    <li id="store-step1">Step 1: Not saved</li>
                    <li id="store-step2">Step 2: Not saved</li>
                    <li id="store-step3">Step 3: Not saved</li>
                    <li id="store-step4">Step 4: ‚ö†Ô∏è NOT IN STORE!</li>
                    <li id="store-step5">Step 5: Not saved</li>
                </ul>
            </div>
            <div class="storage-box local-state">
                <h4>‚ö†Ô∏è Step 4 Local State</h4>
                <ul>
                    <li id="local-gift">Gift Message: <span id="local-gift-value">Empty</span></li>
                    <li id="local-notes">Delivery Notes: <span id="local-notes-value">Empty</span></li>
                    <li id="local-sig">Signature: <span id="local-sig-value">No</span></li>
                </ul>
                <p style="margin-top: 10px; font-size: 12px; color: #721c24;">
                    <strong>‚ö†Ô∏è Warning:</strong> This state is lost when component remounts!
                </p>
            </div>
        </div>
    </div>

    <script>
        // Simulate Global Store (like Redux/Zustand)
        const globalStore = {
            currentStep: 1,
            personalInfo: null,
            shippingAddress: null,
            billingInfo: null,
            // Notice: specialInstructions is NOT here!
            orderReview: null,
        };

        // Simulate Step 4 Local State (like useState)
        let step4LocalState = {
            giftMessage: '',
            deliveryNotes: '',
            signatureRequired: false,
        };

        function renderStep() {
            const step = globalStore.currentStep;
            const content = document.getElementById('step-content');
            
            // Update progress bar
            document.querySelectorAll('.progress-step').forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index + 1 === step) {
                    el.classList.add('active');
                } else if (index + 1 < step) {
                    el.classList.add('completed');
                }
            });

            // Render step content
            switch(step) {
                case 1:
                    content.innerHTML = renderStep1();
                    break;
                case 2:
                    content.innerHTML = renderStep2();
                    break;
                case 3:
                    content.innerHTML = renderStep3();
                    break;
                case 4:
                    // BUG: Step 4 reinitializes local state on every render!
                    step4LocalState = {
                        giftMessage: '',
                        deliveryNotes: '',
                        signatureRequired: false,
                    };
                    updateLocalStateDisplay();
                    content.innerHTML = renderStep4();
                    console.warn('üêõ BUG: Step 4 local state reinitialized to empty values!');
                    break;
                case 5:
                    content.innerHTML = renderStep5();
                    break;
            }
        }

        function renderStep1() {
            const data = globalStore.personalInfo || {};
            return `
                <h2>Step 1: Personal Information</h2>
                <p style="color: #28a745; margin-bottom: 20px;">‚úÖ This step uses the Global Store</p>
                <div class="form-group">
                    <label>First Name:</label>
                    <input type="text" id="firstName" value="${data.firstName || ''}" placeholder="Enter first name">
                </div>
                <div class="form-group">
                    <label>Last Name:</label>
                    <input type="text" id="lastName" value="${data.lastName || ''}" placeholder="Enter last name">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" value="${data.email || ''}" placeholder="Enter email">
                </div>
                <div class="button-group">
                    <button class="btn-secondary" disabled>Back</button>
                    <button class="btn-primary" onclick="saveStep1()">Next ‚Üí</button>
                </div>
            `;
        }

        function renderStep2() {
            const data = globalStore.shippingAddress || {};
            return `
                <h2>Step 2: Shipping Address</h2>
                <p style="color: #28a745; margin-bottom: 20px;">‚úÖ This step uses the Global Store</p>
                <div class="form-group">
                    <label>Street Address:</label>
                    <input type="text" id="street" value="${data.street || ''}" placeholder="123 Main St">
                </div>
                <div class="form-group">
                    <label>City:</label>
                    <input type="text" id="city" value="${data.city || ''}" placeholder="Springfield">
                </div>
                <div class="form-group">
                    <label>Postal Code:</label>
                    <input type="text" id="postalCode" value="${data.postalCode || ''}" placeholder="12345">
                </div>
                <div class="form-group">
                    <label>Country:</label>
                    <input type="text" id="country" value="${data.country || ''}" placeholder="USA">
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="goBack()">‚Üê Back</button>
                    <button class="btn-primary" onclick="saveStep2()">Next ‚Üí</button>
                </div>
            `;
        }

        function renderStep3() {
            const data = globalStore.billingInfo || {};
            return `
                <h2>Step 3: Billing Information</h2>
                <p style="color: #28a745; margin-bottom: 20px;">‚úÖ This step uses the Global Store</p>
                <div class="form-group">
                    <label>Card Number:</label>
                    <input type="text" id="cardNumber" value="${data.cardNumber || ''}" placeholder="1234-5678-9012-3456">
                </div>
                <div class="form-group">
                    <label>Expiry Date:</label>
                    <input type="text" id="expiry" value="${data.expiry || ''}" placeholder="MM/YY">
                </div>
                <div class="form-group">
                    <label>CVV:</label>
                    <input type="text" id="cvv" value="${data.cvv || ''}" placeholder="123">
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="goBack()">‚Üê Back</button>
                    <button class="btn-primary" onclick="saveStep3()">Next ‚Üí</button>
                </div>
            `;
        }

        function renderStep4() {
            // BUG: This always reads from freshly reset local state!
            const data = step4LocalState;
            return `
                <h2>Step 4: Special Instructions</h2>
                <div class="error-box">
                    <h3>üêõ BUG LOCATION</h3>
                    <p><strong>This step uses LOCAL STATE instead of the Global Store!</strong></p>
                    <p>When you navigate back to this step, the component remounts and local state resets to empty.</p>
                </div>
                <div class="form-group">
                    <label>Gift Message:</label>
                    <textarea id="giftMessage" placeholder="Write a heartfelt message...">${data.giftMessage}</textarea>
                </div>
                <div class="form-group">
                    <label>Delivery Instructions:</label>
                    <textarea id="deliveryNotes" placeholder="Special delivery instructions...">${data.deliveryNotes}</textarea>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="signatureRequired" ${data.signatureRequired ? 'checked' : ''}>
                        <label for="signatureRequired">Signature required on delivery</label>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="goBack()">‚Üê Back</button>
                    <button class="btn-primary" onclick="saveStep4()">Next ‚Üí</button>
                </div>
            `;
        }

        function renderStep5() {
            return `
                <h2>Step 5: Review Your Order</h2>
                <p style="color: #28a745; margin-bottom: 20px;">‚úÖ This step uses the Global Store</p>
                
                <div class="success-box">
                    <h3>‚úÖ Data from Global Store</h3>
                    <p><strong>Personal Info:</strong> ${globalStore.personalInfo ? '‚úì Saved' : '‚úó Missing'}</p>
                    <p><strong>Shipping:</strong> ${globalStore.shippingAddress ? '‚úì Saved' : '‚úó Missing'}</p>
                    <p><strong>Billing:</strong> ${globalStore.billingInfo ? '‚úì Saved' : '‚úó Missing'}</p>
                </div>

                <div class="error-box">
                    <h3>‚ùå Step 4 Data (NOT in Global Store)</h3>
                    <p><strong>Special Instructions:</strong> ‚ö†Ô∏è NOT IN GLOBAL STORE!</p>
                    <p>Gift Message: "${step4LocalState.giftMessage || 'EMPTY'}"</p>
                    <p>Delivery Notes: "${step4LocalState.deliveryNotes || 'EMPTY'}"</p>
                    <p style="margin-top: 10px; font-size: 14px;">
                        <strong>Try clicking "Back" to edit Step 4, then come back here.</strong><br>
                        You'll see that all Step 4 data is lost! üêõ
                    </p>
                </div>

                <div class="data-preview">
${JSON.stringify({
    step1: globalStore.personalInfo,
    step2: globalStore.shippingAddress,
    step3: globalStore.billingInfo,
    step4: 'NOT IN STORE - Only in local state (will be lost!)',
    step5: 'Current step'
}, null, 2)}
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="termsAccepted">
                        <label for="termsAccepted">I accept the terms and conditions</label>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" onclick="goBack()">‚Üê Back (Try going to Step 4!)</button>
                    <button class="btn-primary" onclick="completeOrder()">Complete Order</button>
                </div>
            `;
        }

        function saveStep1() {
            globalStore.personalInfo = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
            };
            document.getElementById('store-step1').textContent = 'Step 1: ‚úì Saved to Global Store';
            console.log('‚úÖ Step 1 saved to Global Store:', globalStore.personalInfo);
            goNext();
        }

        function saveStep2() {
            globalStore.shippingAddress = {
                street: document.getElementById('street').value,
                city: document.getElementById('city').value,
                postalCode: document.getElementById('postalCode').value,
                country: document.getElementById('country').value,
            };
            document.getElementById('store-step2').textContent = 'Step 2: ‚úì Saved to Global Store';
            console.log('‚úÖ Step 2 saved to Global Store:', globalStore.shippingAddress);
            goNext();
        }

        function saveStep3() {
            globalStore.billingInfo = {
                cardNumber: document.getElementById('cardNumber').value,
                expiry: document.getElementById('expiry').value,
                cvv: document.getElementById('cvv').value,
            };
            document.getElementById('store-step3').textContent = 'Step 3: ‚úì Saved to Global Store';
            console.log('‚úÖ Step 3 saved to Global Store:', globalStore.billingInfo);
            goNext();
        }

        function saveStep4() {
            // BUG: Saves to local state, NOT to Global Store!
            step4LocalState.giftMessage = document.getElementById('giftMessage').value;
            step4LocalState.deliveryNotes = document.getElementById('deliveryNotes').value;
            step4LocalState.signatureRequired = document.getElementById('signatureRequired').checked;
            
            updateLocalStateDisplay();
            console.warn('‚ö†Ô∏è BUG: Step 4 saved to LOCAL STATE (not Global Store):', step4LocalState);
            console.warn('‚ö†Ô∏è This data will be LOST if user navigates back to Step 4!');
            goNext();
        }

        function updateLocalStateDisplay() {
            document.getElementById('local-gift-value').textContent = 
                step4LocalState.giftMessage || 'Empty';
            document.getElementById('local-notes-value').textContent = 
                step4LocalState.deliveryNotes || 'Empty';
            document.getElementById('local-sig-value').textContent = 
                step4LocalState.signatureRequired ? 'Yes' : 'No';
        }

        function goNext() {
            if (globalStore.currentStep < 5) {
                globalStore.currentStep++;
                renderStep();
            }
        }

        function goBack() {
            if (globalStore.currentStep > 1) {
                globalStore.currentStep--;
                if (globalStore.currentStep === 4) {
                    console.error('üêõüêõüêõ BUG TRIGGERED! Navigating back to Step 4 - local state will reset! üêõüêõüêõ');
                }
                renderStep();
            }
        }

        function completeOrder() {
            const termsAccepted = document.getElementById('termsAccepted').checked;
            if (!termsAccepted) {
                alert('Please accept the terms and conditions');
                return;
            }

            alert('üêõ Order "Complete" - but Step 4 data is MISSING from the Global Store!\n\nThis bug would cause:\n- Lost gift messages\n- Missing delivery instructions\n- Incomplete orders\n- Customer complaints');
            
            console.error('üêõ CRITICAL BUG: Order submitted with INCOMPLETE data!');
            console.error('Global Store:', globalStore);
            console.error('Step 4 Local State (NOT SUBMITTED):', step4LocalState);
        }

        // Initialize
        renderStep();
    </script>
</body>
</html>
